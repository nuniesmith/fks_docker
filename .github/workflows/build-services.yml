name: Build and Push Service Images

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to build (leave empty for all)'
        required: false
        type: choice
        options:
          - ''
          - web
          - api
          - app
          - data
          - ai
          - analyze
          - training
          - portfolio
          - monitor
          - ninja
          - execution
          - auth
          - meta
          - main
          - tailscale
          - nginx
  schedule:
    # Run daily at 2 AM UTC to rebuild images
    - cron: '0 2 * * *'
  push:
    branches: [main]
    paths:
      - 'Dockerfile.*'
      - 'build-all.sh'

env:
  DOCKER_USERNAME: nuniesmith
  DOCKER_REPO: nuniesmith/fks

jobs:
  build-services:
    runs-on: ubuntu-latest
    name: Build Service Images
    
    steps:
      - name: Checkout docker repo
        uses: actions/checkout@v4
        with:
          path: docker-repo

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Pull base images
        run: |
          docker pull ${{ env.DOCKER_REPO }}:docker || echo "CPU base not found"
          docker pull ${{ env.DOCKER_REPO }}:docker-ml || echo "ML base not found"
          docker pull ${{ env.DOCKER_REPO }}:docker-gpu || echo "GPU base not found"

      - name: Setup build script
        run: |
          cd docker-repo
          chmod +x build-all.sh

      - name: Build and push services
        env:
          PUSH_TO_HUB: "true"
          BUILD_BASE: "false"  # Don't rebuild base images, use existing ones
          SERVICE_FILTER: ${{ github.event.inputs.service }}
        run: |
          cd docker-repo
          if [ -n "$SERVICE_FILTER" ] && [ "$SERVICE_FILTER" != "" ]; then
            ./build-all.sh --service "$SERVICE_FILTER"
          else
            ./build-all.sh
          fi

      - name: Build summary
        if: always()
        run: |
          echo "=== Build Summary ==="
          echo "Built service images: ${{ env.DOCKER_REPO }}:<service>-latest"
          docker images | grep "${{ env.DOCKER_REPO }}" | head -20

