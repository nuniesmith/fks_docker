name: Build and Push All Service Images

on:
  push:
    branches: [main, develop]
    paths:
      - 'Dockerfile.*'
      - '.github/workflows/build-all-services.yml'
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      service:
        description: 'Specific service to build (leave empty for all)'
        required: false
        type: string

env:
  DOCKER_USERNAME: nuniesmith
  DOCKER_REPO: nuniesmith/fks
  BASE_IMAGE_CPU: nuniesmith/fks:docker
  BASE_IMAGE_ML: nuniesmith/fks:docker-ml
  BASE_IMAGE_GPU: nuniesmith/fks:docker-gpu

jobs:
  # Build base images first (if they don't exist or need updating)
  ensure-base-images:
    runs-on: ubuntu-latest
    name: Ensure Base Images Exist
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to DockerHub
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Pull base images
        if: github.event_name != 'pull_request'
        run: |
          docker pull ${{ env.BASE_IMAGE_CPU }} || echo "CPU base not found, will need to build"
          docker pull ${{ env.BASE_IMAGE_ML }} || echo "ML base not found, will need to build"
          docker pull ${{ env.BASE_IMAGE_GPU }} || echo "GPU base not found, will need to build"

  # Service configuration: service_name:dockerfile:base_image:service_dir
  build-web:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'web'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/web
          path: web-repo
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push web
        uses: docker/build-push-action@v6
        with:
          context: ./web-repo
          file: ./docker-repo/Dockerfile.web_ui
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:web-latest
          cache-from: type=gha,scope=web
          cache-to: type=gha,mode=max,scope=web

  build-api:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'api'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/api
          path: api-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push api
        uses: docker/build-push-action@v6
        with:
          context: ./api-repo
          file: ./docker-repo/Dockerfile.api
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:api-latest
          cache-from: type=gha,scope=api
          cache-to: type=gha,mode=max,scope=api

  build-app:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'app'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/app
          path: app-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push app
        uses: docker/build-push-action@v6
        with:
          context: ./app-repo
          file: ./docker-repo/Dockerfile.app
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:app-latest
          cache-from: type=gha,scope=app
          cache-to: type=gha,mode=max,scope=app

  build-data:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'data'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/data
          path: data-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push data
        uses: docker/build-push-action@v6
        with:
          context: ./data-repo
          file: ./docker-repo/Dockerfile.data
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:data-latest
          cache-from: type=gha,scope=data
          cache-to: type=gha,mode=max,scope=data

  build-ai:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'ai'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/ai
          path: ai-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_ML }} || true
      - name: Build and push ai
        uses: docker/build-push-action@v6
        with:
          context: ./ai-repo
          file: ./docker-repo/Dockerfile.ai
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:ai-latest
          cache-from: type=gha,scope=ai
          cache-to: type=gha,mode=max,scope=ai

  build-analyze:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'analyze'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/analyze
          path: analyze-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_ML }} || true
      - name: Build and push analyze
        uses: docker/build-push-action@v6
        with:
          context: ./analyze-repo
          file: ./docker-repo/Dockerfile.analyze
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:analyze-latest
          cache-from: type=gha,scope=analyze
          cache-to: type=gha,mode=max,scope=analyze

  build-training:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'training'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/training
          path: training-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_GPU }} || true
      - name: Build and push training
        uses: docker/build-push-action@v6
        with:
          context: ./training-repo
          file: ./docker-repo/Dockerfile.training
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:training-latest
          cache-from: type=gha,scope=training
          cache-to: type=gha,mode=max,scope=training

  build-portfolio:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'portfolio'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/portfolio
          path: portfolio-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push portfolio
        uses: docker/build-push-action@v6
        with:
          context: ./portfolio-repo
          file: ./docker-repo/Dockerfile.portfolio
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:portfolio-latest
          cache-from: type=gha,scope=portfolio
          cache-to: type=gha,mode=max,scope=portfolio

  build-monitor:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'monitor'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/monitor
          path: monitor-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push monitor
        uses: docker/build-push-action@v6
        with:
          context: ./monitor-repo
          file: ./docker-repo/Dockerfile.monitor
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:monitor-latest
          cache-from: type=gha,scope=monitor
          cache-to: type=gha,mode=max,scope=monitor

  build-ninja:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'ninja'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/ninja
          path: ninja-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push ninja
        uses: docker/build-push-action@v6
        with:
          context: ./ninja-repo
          file: ./docker-repo/Dockerfile.ninja
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:ninja-latest
          cache-from: type=gha,scope=ninja
          cache-to: type=gha,mode=max,scope=ninja

  build-execution:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'execution'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/execution
          path: execution-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push execution
        uses: docker/build-push-action@v6
        with:
          context: ./execution-repo
          file: ./docker-repo/Dockerfile.execution
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:execution-latest
          cache-from: type=gha,scope=execution
          cache-to: type=gha,mode=max,scope=execution

  build-auth:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'auth'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/auth
          path: auth-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push auth
        uses: docker/build-push-action@v6
        with:
          context: ./auth-repo
          file: ./docker-repo/Dockerfile.auth
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:auth-latest
          cache-from: type=gha,scope=auth
          cache-to: type=gha,mode=max,scope=auth

  build-meta:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'meta'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/meta
          path: meta-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push meta
        uses: docker/build-push-action@v6
        with:
          context: ./meta-repo
          file: ./docker-repo/Dockerfile.meta
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:meta-latest
          cache-from: type=gha,scope=meta
          cache-to: type=gha,mode=max,scope=meta

  build-main:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'main'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/main
          path: main-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Pull base image
        if: github.event_name != 'pull_request'
        run: docker pull ${{ env.BASE_IMAGE_CPU }} || true
      - name: Build and push main
        uses: docker/build-push-action@v6
        with:
          context: ./main-repo
          file: ./docker-repo/Dockerfile.main
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:main-latest
          cache-from: type=gha,scope=main
          cache-to: type=gha,mode=max,scope=main

  build-tailscale:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'tailscale'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/tailscale
          path: tailscale-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Build and push tailscale
        uses: docker/build-push-action@v6
        with:
          context: ./tailscale-repo
          file: ./docker-repo/Dockerfile.tailscale
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:tailscale-latest
          cache-from: type=gha,scope=tailscale
          cache-to: type=gha,mode=max,scope=tailscale

  build-nginx:
    needs: ensure-base-images
    runs-on: ubuntu-latest
    if: github.event.inputs.service == '' || github.event.inputs.service == 'nginx'
    steps:
      - uses: actions/checkout@v4
        with:
          path: docker-repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/nginx
          path: nginx-repo
          token: ${{ secrets.GITHUB_TOKEN }}
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        if: github.event_name != 'pull_request'
        with:
          username: ${{ env.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Build and push nginx
        uses: docker/build-push-action@v6
        with:
          context: ./nginx-repo
          file: ./docker-repo/Dockerfile.nginx
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ env.DOCKER_REPO }}:nginx-latest
          cache-from: type=gha,scope=nginx
          cache-to: type=gha,mode=max,scope=nginx

  build-summary:
    runs-on: ubuntu-latest
    needs: [build-web, build-api, build-app, build-data, build-ai, build-analyze, build-training, build-portfolio, build-monitor, build-ninja, build-execution, build-auth, build-meta, build-main, build-tailscale, build-nginx]
    if: always()
    steps:
      - name: Build summary
        run: |
          echo "=== Service Image Build Summary ==="
          echo "Web: ${{ needs.build-web.result }}"
          echo "API: ${{ needs.build-api.result }}"
          echo "App: ${{ needs.build-app.result }}"
          echo "Data: ${{ needs.build-data.result }}"
          echo "AI: ${{ needs.build-ai.result }}"
          echo "Analyze: ${{ needs.build-analyze.result }}"
          echo "Training: ${{ needs.build-training.result }}"
          echo "Portfolio: ${{ needs.build-portfolio.result }}"
          echo "Monitor: ${{ needs.build-monitor.result }}"
          echo "Ninja: ${{ needs.build-ninja.result }}"
          echo "Execution: ${{ needs.build-execution.result }}"
          echo "Auth: ${{ needs.build-auth.result }}"
          echo "Meta: ${{ needs.build-meta.result }}"
          echo "Main: ${{ needs.build-main.result }}"
          echo "Tailscale: ${{ needs.build-tailscale.result }}"
          echo "Nginx: ${{ needs.build-nginx.result }}"
          echo ""
          echo "All images: ${{ env.DOCKER_REPO }}:<service>-latest"

